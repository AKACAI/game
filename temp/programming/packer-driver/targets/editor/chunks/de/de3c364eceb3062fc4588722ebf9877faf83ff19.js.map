{"version":3,"sources":["file:///D:/cocos_projects/physics_education_game/assets/scripts/manager/TimerManager.ts"],"names":["TimerManager","PriorityQueue","Utils","_getID","_curID","init","_timerList","a","b","_nextTriggerTime","_insertList","Array","console","log","update","count","Math","min","length","_dealInsertCount","i","insertTimer","shift","push","execute","topTimer","top","getCurTimeStamp","pop","_isDestroy","_loop","_triggerTime","_callback","_param","_target","addTimer","delayTime","isLoop","triggerTime","callback","param","target","id","timer","_id","_delayTime","removeTimer","targetIndex","findIndex","splice","find","print","toString"],"mappings":"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","sourcesContent":["import PriorityQueue from \"../utils/PriorityQueue\";\r\nimport Utils from \"../utils/Utils\";\r\n\r\n// 加载任务\r\ninterface TimerTask {\r\n   _id: number;\r\n   _triggerTime: number; //每次触发间隔时间(ms)\r\n   _delayTime: number; //第一次触发的延迟时间(ms)\r\n   _nextTriggerTime: number; //下次触发的时间戳(ms)\r\n   _loop: boolean; //是否循环\r\n   _param: any; //附带数据\r\n   _isDestroy: boolean;     //定时器是否被销毁\r\n   _callback: any; //回调函数\r\n   _target: any; //回调函数所在的对象\r\n}\r\n\r\nexport default class TimerManager {\r\n    private static _timerList: PriorityQueue<TimerTask>;\r\n\r\n    private static _insertList: Array<TimerTask>;\r\n    //private static _curTimeStamp : number;  // 当前的时间戳\r\n\r\n    private static readonly _dealInsertCount = 10;  // 一帧里面最多可以插入多少个定时器\r\n\r\n    private static _curID: number = 0;\r\n    private static get _getID(): number {\r\n        return this._curID++;\r\n    }\r\n\r\n    public static init() {\r\n        TimerManager._timerList = new PriorityQueue<TimerTask>((a: TimerTask, b: TimerTask) : number => {\r\n            if (a._nextTriggerTime > b._nextTriggerTime) {\r\n                return 1;\r\n            }\r\n            else if (a._nextTriggerTime == b._nextTriggerTime) {\r\n                return 0;\r\n            }\r\n            else {\r\n                return -1;\r\n            }\r\n        });\r\n        TimerManager._insertList = new Array<TimerTask>();\r\n        console.log(\"TimerManager初始化完成!\");\r\n    }\r\n\r\n    public static update() {\r\n        // 遍历插入列表，最多_dealInsertCount个地插入到优先级队列里面\r\n        let count = Math.min(this._insertList.length, TimerManager._dealInsertCount);\r\n        for (let i = 0; i < count; i++) {\r\n            let insertTimer = this._insertList.shift();\r\n            \r\n            // TODO 可能是这个push的问题？\r\n            this._timerList.push(insertTimer);\r\n        }\r\n\r\n        TimerManager.execute();\r\n    }\r\n\r\n    private static execute() {\r\n        let topTimer = this._timerList.top();\r\n        if (topTimer && topTimer._nextTriggerTime <= Utils.getCurTimeStamp()) {\r\n            // console.log(this._timerList);\r\n            topTimer = this._timerList.pop();\r\n            if (topTimer._isDestroy) {\r\n                TimerManager.execute();\r\n                return;\r\n            }\r\n            if (topTimer._loop) {\r\n                topTimer._nextTriggerTime = Utils.getCurTimeStamp() + topTimer._triggerTime;\r\n                TimerManager._insertList.push(topTimer);\r\n            }\r\n            topTimer._callback(topTimer._param, topTimer._target);\r\n            TimerManager.execute();\r\n            return;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 添加一个定时器\r\n     * @param delayTime 第一次延迟多久触发（ms），如果是0则立即触发\r\n     * @param isLoop 是否循环\r\n     * @param triggerTime 每次触发的时间间隔（ms）\r\n     * @param callback 回调\r\n     * @param param 参数\r\n     * @param target 回调的对象\r\n     * @returns \r\n     */\r\n    public static addTimer(delayTime: number = 0, isLoop: boolean, triggerTime: number, callback: any, param?: any, \r\n         target: any = this): number {\r\n        if (triggerTime <=0 || delayTime < 0) {\r\n            console.log(\"定时器的触发时间不能为负数！！！！！！\");\r\n            return -1;\r\n        }\r\n        let id = TimerManager._getID;\r\n        let timer: TimerTask = {\r\n            _id: id,\r\n            _callback: callback,\r\n            _loop: isLoop,\r\n            _param: param,\r\n            _triggerTime: triggerTime,\r\n            _delayTime: delayTime,\r\n            _target: target,\r\n            _nextTriggerTime: Utils.getCurTimeStamp() + delayTime,\r\n            _isDestroy: false,\r\n        }\r\n        TimerManager._insertList.push(timer);\r\n        return id;\r\n    }\r\n\r\n    /**\r\n     * 通过id删除一个定时器\r\n     * @param id 目标id\r\n     * @returns 是否成功删除\r\n     */\r\n    public static removeTimer(id: number): boolean {\r\n        // 如果该定时器在插入列表中，就直接移除并返回就好了\r\n        let targetIndex = this._insertList.findIndex((timer) => {\r\n            return timer._id == id;\r\n        });\r\n        if (targetIndex >= 0) {\r\n            this._insertList.splice(targetIndex);\r\n            return true;\r\n        }\r\n\r\n        // 找到在优先级队列里的目标，直接把摧毁标志置为true，当定时器遇到它的时候直接跳过它即可\r\n        let timer = this._timerList.find((a: TimerTask): boolean => {\r\n            return a._id == id;\r\n        });\r\n        if (timer) {\r\n            timer._isDestroy = true;\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    // TODO 通过回调删除一个定时器\r\n\r\n    public static print() {\r\n        TimerManager._timerList.print((a: TimerTask): string => {\r\n            return a._id.toString();\r\n        });\r\n    }\r\n}"]}