{"version":3,"sources":["file:///D:/cocos_projects/physics_education_game/assets/scripts/manager/ui_manager/component/ComButton.ts"],"names":["_decorator","Component","Node","Vec2","LogManager","Utils","EventManager","EventConstants","ccclass","property","ComButton","eventDict","undefined","isInited","_isPressed","clickBufferTime","scaleTarget","lastClickTime","isDoAnim","_blockClickEvent","onLoad","init","onDestroy","removeAllEvent","blockClickEvent","reset","onEnable","node","on","EventType","TOUCH_START","_onTouchStart","TOUCH_MOVE","_onTouchMove","TOUCH_END","_onTouchEnd","TOUCH_CANCEL","_onTouchCancel","onDisable","off","event","console","log","name","enabledInHierarchy","propagationStopped","setScale","dispatchEvent","InputSystem","ClickStart","dis","distance","getStartLocation","getLocation","onClick","getCurTimeStamp","events","ButtonEventType","click","i","length","func","apply","target","params","addEvent","data","type","push","removeEvent","arr","splice","removeAllEventByType"],"mappings":"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","sourcesContent":["import { _decorator, Component, EventTouch, Node, NodeEventType, Vec2 } from 'cc';\r\nimport LogManager from '../../../utils/LogManager';\r\nimport Utils from '../../../utils/Utils';\r\nimport EventManager from '../../event_manager/EventManager';\r\nimport { EventConstants } from '../../event_manager/EventConstants';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('ComButton')\r\nexport class ComButton extends Component {\r\n    private eventDict: { [type: number]: ButtonEventArgs[] } = undefined;\r\n\r\n    private isInited: boolean = false;\r\n\r\n    public onLoad(): void {\r\n        this.init(true, true);\r\n    }\r\n\r\n    public onDestroy(): void {\r\n        this.removeAllEvent();\r\n    }\r\n\r\n    private _isPressed: boolean = false;\r\n    /** 两次点击的缓存时间*/\r\n    private readonly clickBufferTime = 250;\r\n    /** 点击后动画缩放比例 */\r\n    private readonly scaleTarget = 0.9;\r\n    private lastClickTime: number = 0;\r\n\r\n    private isDoAnim: boolean = false;\r\n    private _blockClickEvent: boolean = false;\r\n\r\n    public init(isDoAnim: boolean = true, blockClickEvent: boolean = true) {\r\n        if (this.isInited) {\r\n            return;\r\n        }\r\n        this.isInited = true;\r\n        this.isDoAnim = isDoAnim;\r\n        this._blockClickEvent = blockClickEvent;\r\n        this.eventDict = {};\r\n        this.reset();\r\n    }\r\n\r\n    private reset() {\r\n        this.lastClickTime = 0;\r\n        this._isPressed = false;\r\n    }\r\n\r\n    onEnable() {\r\n        this.node.on(Node.EventType.TOUCH_START, this._onTouchStart, this)\r\n        this.node.on(Node.EventType.TOUCH_MOVE, this._onTouchMove, this)\r\n        this.node.on(Node.EventType.TOUCH_END, this._onTouchEnd, this)\r\n        this.node.on(Node.EventType.TOUCH_CANCEL, this._onTouchCancel, this)\r\n    }\r\n\r\n    onDisable() {\r\n        this.reset();\r\n        this.node.off(Node.EventType.TOUCH_START, this._onTouchStart, this)\r\n        this.node.off(Node.EventType.TOUCH_MOVE, this._onTouchMove, this)\r\n        this.node.off(Node.EventType.TOUCH_END, this._onTouchEnd, this)\r\n        this.node.off(Node.EventType.TOUCH_CANCEL, this._onTouchCancel, this)\r\n    }\r\n\r\n    //#region 点击逻辑\r\n\r\n    private _onTouchStart(event: EventTouch) {\r\n        console.log(\"_onTouchStart: \", this.node.name);\r\n        if (!this.enabledInHierarchy) {\r\n            return\r\n        }\r\n\r\n        this._isPressed = true;\r\n        if (event && this._blockClickEvent) {\r\n            event.propagationStopped = true;\r\n        }\r\n        if (this.isDoAnim) {\r\n            this.node.setScale(this.scaleTarget, this.scaleTarget, this.scaleTarget);\r\n        }\r\n        EventManager.dispatchEvent(EventConstants.InputSystem.ClickStart, this.node);\r\n    }\r\n\r\n    private _onTouchMove(event: EventTouch) {\r\n        console.log(\"_onTouchMove: \", this.node.name);\r\n        if (!!this.enabledInHierarchy || !this._isPressed) {\r\n            return;\r\n        }\r\n        if (!event) {\r\n            return false;\r\n        }\r\n        if (event && this._blockClickEvent) {\r\n            event.propagationStopped = true;\r\n        }\r\n    }\r\n\r\n    private _onTouchEnd(event: EventTouch) {\r\n        console.log(\"_onTouchEnd: \", this.node.name);\r\n        if (!this.enabledInHierarchy) {\r\n            return\r\n        }\r\n\r\n        if (this._isPressed) {\r\n            let dis = Vec2.distance(event.getStartLocation(), event.getLocation())\r\n            if (dis < 10) {  //移动不超过10像素才判断为点击\r\n                this.onClick(event)\r\n            }\r\n        }\r\n\r\n        if (this.isDoAnim) {\r\n            this.node.setScale(1, 1, 1);\r\n        }\r\n        this._isPressed = false;\r\n        if (event && this._blockClickEvent) {\r\n            event.propagationStopped = true;\r\n        }\r\n    }\r\n\r\n    private _onTouchCancel(event: EventTouch) {\r\n        console.log(\"_onTouchCancel: \", this.node.name);\r\n        if (!this.enabledInHierarchy) {\r\n            return;\r\n        }\r\n        if (this.isDoAnim) {\r\n            this.node.setScale(1, 1, 1);\r\n        }\r\n        this._isPressed = false;\r\n    }\r\n\r\n    private onClick(event: EventTouch) {\r\n        LogManager.log(\"点击了按钮：\", this.node.name);\r\n        if (Utils.getCurTimeStamp() - this.lastClickTime > this.clickBufferTime) {\r\n            let events: ButtonEventArgs[] = this.eventDict[ButtonEventType.click];\r\n            if (events) {\r\n                for (let i = 0; i < events.length; i++) {\r\n                    events[i].func.apply(events[i].target, events[i].params);\r\n                }\r\n            }\r\n        } else {\r\n\r\n        }\r\n        this.lastClickTime = Utils.getCurTimeStamp();\r\n    }\r\n\r\n    public addEvent(data: ButtonEventArgs) {\r\n        if (!this.eventDict[data.type]) {\r\n            this.eventDict[data.type] = [];\r\n        }\r\n        this.eventDict[data.type].push(data);\r\n    }\r\n\r\n    public removeEvent(func: Function) {\r\n        for (let type in this.eventDict) {\r\n            let arr = this.eventDict[type];\r\n            if (!arr) {\r\n                continue;\r\n            }\r\n            for (let i = 0; i < arr.length; i++) {\r\n                if (arr[i].func == func) {\r\n                    arr.splice(i, 1);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public removeAllEventByType(type: ButtonEventType) {\r\n        this.eventDict[type] = [];\r\n    }\r\n\r\n    public removeAllEvent() {\r\n        this.eventDict = {};\r\n    }\r\n}\r\n\r\nexport enum ButtonEventType {\r\n    click = 1,\r\n    doubleClick = 2,\r\n}\r\n\r\nexport interface ButtonEventArgs {\r\n    type: ButtonEventType,\r\n    func: Function,\r\n    target: any,\r\n    params: any,\r\n}"]}